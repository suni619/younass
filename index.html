<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Player assignments</title>
  <link href="css/bootstrap.min.css" rel="stylesheet"> <!-- bootswatch/lux theme -->
</head>
<body>
<h1>Youngistan <small class="text-body-secondary">duties tracker</small></h1>

<h2>Player Roster</h2>
<table id="playerTable" border="1">
  <thead>
    <tr>
      <th></th> <!-- for add button -->
      <th>Name</th>
      <th>Games</th>
      <th>Refreshments</th>
      <th>Last Refreshments</th>
      <th>Ground Setup</th>
      <th>Last Setup</th>
      <th>Games to refreshments ratio</th>
      <th>Games to setup ratio</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div class="card border-primary mb-3" style="max-width: 20rem;">
  <div class="card-body">
    <h4 class="card-title">Playing XI</h4>
    <p class="card-text">
      <ol id="selectedPlayersList"></ol>
    </p>
  </div>
</div>
<button type="button" class="btn btn-primary" id="assignDutiesButton">Assign Duties</button>
  
<div class="card border-primary mb-3" style="max-width: 20rem; display:none" id="refreshmentsCard">
  <div class="card-body">
    <h4 class="card-title">Refreshments: </h4>
    <p class="card-text" id="refreshmentAssignedPlayer"></p>
  </div>
</div>

<div class="card border-primary mb-3" style="max-width: 20rem; display:none" id="setupCard">
  <div class="card-body">
    <h4 class="card-title">Ground setup: </h4>
    <p class="card-text">
      <ul id="setupAssignedPlayers"></ul>
    </p>
  </div>
</div>

<script>
  // Data structure to store the CSV data
  let playerData = [];
  let selectedPlayers = [];

  // Fetch CSV file and initiate parsing and displaying
  function loadCSVFile() {
    fetch('players.csv')  // Path to your CSV file
      .then(response => response.text())
      .then(data => {
        playerData = parseCSVData(data);  // Parse the CSV data and store it
        displayRoster(playerData);         // Display the data in a table
      })
      .catch(error => console.error('Error fetching the CSV file:', error));
  }

  // Parse the CSV data and return an array of player objects
  function parseCSVData(data) {
    const rows = data.split('\n');
    const parsedData = [];

    for (let i = 1; i < rows.length; i++) {
      const row = rows[i].trim();
      if (row) { // Ignore empty rows
        const cols = row.split(',');
        const games = parseInt(cols[1]);
        const ref = parseInt(cols[2]);
        const setup = parseInt(cols[4])
        
        const player = {
          name: cols[0],
          games: games,
          ref: ref,
          lastRef: cols[3],
          setup: setup,
          lastSetup: cols[5],
          ratioGamesToRef: ref > 0 ? games / ref : 100,
          ratioGamesToSetup: setup > 0 ? games / setup : 100
        };
        parsedData.push(player);
      }
    }
    return parsedData;  // Return the parsed data array
  }

  // Extract the player names from the data and return a sorted array
  function getSortedPlayers(data) {
    const playerNames = data.map(player => player.player);  // Extract player field
    return playerNames.sort();  // Sort the player names alphabetically
  }
  
  // Display the data in the table
  function displayRoster(data) {
    const tableBody = document.querySelector('#playerTable tbody');
    tableBody.innerHTML = ''; // Clear any existing data

    // Create a table row for each player object
    data.forEach(player => {
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      // Create an "Add" button for each player
      const addButton = document.createElement('button');
      addButton.textContent = 'Add';
      addButton.onclick = function() {
        addPlayerToSelection(player);  // Add player to the selected list
      };
      td.appendChild(addButton);
      tr.appendChild(td);
      
      Object.values(player).forEach(value => {
        const td = document.createElement('td');
        td.textContent = value;
        tr.appendChild(td);
      });
      tableBody.appendChild(tr);
    });
  }

  // Add player to selectedPlayers array and update display
  function addPlayerToSelection(player) {
    // Check if player is already selected
    if (!selectedPlayers.includes(player)) {
      selectedPlayers.push(player);  // Add to selectedPlayers array
      displaySelectedPlayers();  // Update the displayed selected list
    }
  }

  // Display the selected players
  function displaySelectedPlayers() {
    const selectedList = document.querySelector('#selectedPlayersList');
    selectedList.innerHTML = '';  // Clear existing list

    selectedPlayers.forEach(player => {
      const li = document.createElement('li');
      li.textContent = player.name;
      selectedList.appendChild(li);
    });
  }

  function assignDuties() {
    // assign refreshments
    selectedPlayers.sort((a, b) => {
      // sort by ratio in descending order
      if (a.ratioGamesToRef > b.ratioGamesToRef) return -1;
      if (a.ratioGamesToRef < b.ratioGamesToRef) return 1;

      // break tie using last assignment
      if (new Date(a.lastRef) < new Date(b.lastRef)) return -1;
      if (new Date(a.lastRef) > new Date(b.lastRef)) return 1;

      // no sorting needed
      return 0;
    });
    console.log(selectedPlayers);
    
    const refreshmentAssignedPlayer = selectedPlayers.shift();
    console.log("Ref", refreshmentAssignedPlayer);
    const refreshmentAssignedPlayerTag = document.querySelector('#refreshmentAssignedPlayer');
    refreshmentAssignedPlayerTag.textContent = refreshmentAssignedPlayer.name;
    document.querySelector('#refreshmentsCard').style.display = "block";

    // assign ground setup
    selectedPlayers.sort((a, b) => {
      // sort by ratio in descending order
      if (a.ratioGamesToSetup > b.ratioGamesToSetup) return -1;
      if (a.ratioGamesToSetup < b.ratioGamesToSetup) return 1;

      // break tie using last assignment
      if (new Date(a.lastSetup) < new Date(b.lastSetup)) return -1;
      if (new Date(a.lastSetup) > new Date(b.lastSetup)) return 1;

      // no sorting needed
      return 0;
    });
    
    const setupAssignedPlayerList = document.querySelector('#setupAssignedPlayers');
    setupAssignedPlayerList.innerHTML = '';
    for (let i = 0; i < 3; i++) {
      const setupAssignedPlayer = selectedPlayers.shift();
      const li = document.createElement('li');
      li.textContent = setupAssignedPlayer.name;
      setupAssignedPlayerList.appendChild(li);
      console.log("Setup", setupAssignedPlayer);
    }
    document.querySelector('#setupCard').style.display = "block";
  }

  // assign duties
  document.querySelector('#assignDutiesButton').addEventListener('click', assignDuties);
  
  // Load CSV when the page loads
  window.onload = function() {
    loadCSVFile();
  };
</script>

</body>
</html>
